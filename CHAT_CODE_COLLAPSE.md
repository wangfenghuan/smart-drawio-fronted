# ✨ 聊天面板代码块折叠功能

## 🎯 问题

之前聊天面板中，AI 生成的 XML 代码块非常长，多个消息堆在一起时：
- ❌ 占用大量空间
- ❌ 难以查看历史消息
- ❌ 用户体验差

## ✅ 解决方案

使用 **shadcn/ui 的 Collapsible 组件**，将长代码块默认折叠，用户可以按需展开查看。

---

## 🔧 实现细节

### **智能判断代码长度**

```typescript
const codeContent = String(children).replace(/\n$/, "")
const isLongCode = codeContent.length > 500  // 超过500字符认为是长代码
```

- **短代码（≤500字符）**：默认展开显示
- **长代码（>500字符）**：默认折叠

### **折叠状态显示**

#### 头部（可点击展开）

```
┌─────────────────────────────────────────────┐
│ 📦 xml  (5234 字符, 128+ 行)   点击展开  ▼  │
└─────────────────────────────────────────────┘
```

#### 底部提示（折叠时显示）

```
┌─────────────────────────────────────────────┐
│      点击展开查看完整代码...                │
└─────────────────────────────────────────────┘
```

### **展开状态显示**

```
┌─────────────────────────────────────────────┐
│ 📦 xml  (5234 字符, 128+ 行)   点击收起  ▲  │
├─────────────────────────────────────────────┤
│ <mxfile>                                    │
│   <diagram id="page-1">                    │
│     <mxGraphModel>                         │
│       ... (完整代码，可滚动) ...            │
│                                             │
└─────────────────────────────────────────────┘
```

---

## 📦 使用的 shadcn/ui 组件

完全复用了 `components/ui/collapsible.tsx`：

```typescript
import {
    Collapsible,
    CollapsibleContent,
    CollapsibleTrigger,
} from "@/components/ui/collapsible"
```

### **Collapsible 组件说明**

- **Collapsible** - 折叠容器
- **CollapsibleTrigger** - 触发折叠/展开的区域
- **CollapsibleContent** - 折叠的内容区域

---

## 🎨 UI 效果

### 短代码（≤500字符）

直接展开显示，无需折叠：

```
┌────────────────────────────────────────┐
│ 📦 json                               │
├────────────────────────────────────────┤
│ {                                     │
│   "name": "test",                     │
│   "value": 123                        │
│ }                                     │
└────────────────────────────────────────┘
```

### 长代码（>500字符）

#### 默认折叠状态

```
AI 助手
├────────────────────────────────────┐
│ 🔧 [display_diagram]创建图表:      │
│                                    │
│ ┌──────────────────────────────┐   │
│ │📦 xml (5234 字符, 128+ 行)  ▼│   │
│ └──────────────────────────────┘   │
│ ┌──────────────────────────────┐   │
│ │  点击展开查看完整代码...     │   │
│ └──────────────────────────────┘   │
│                                    │
│ ✅ 图表已生成                       │
└────────────────────────────────────┘
```

#### 展开状态

```
AI 助手
├────────────────────────────────────┐
│ 🔧 [display_diagram]创建图表:      │
│                                    │
│ ┌──────────────────────────────┐   │
│ │📦 xml (5234 字符, 128+ 行)  ▲│   │
│ ├──────────────────────────────┤   │
│ │ <mxfile>                     │   │
│ │   <diagram id="page-1">      │   │
│ │     <mxGraphModel>          │   │
│ │       <root>                │   │
│ │         ...完整代码...       │   │
│ │       </root>               │   │
│ │     </mxGraphModel>         │   │
│ │   </diagram>                │   │
│ │ </mxfile>                    │   │
│ │                              │   │
│ │ (可滚动查看更多)              │   │
│ └──────────────────────────────┘   │
│                                    │
│ ✅ 图表已生成                       │
└────────────────────────────────────┘
```

---

## 🎯 关键特性

### 1. **智能折叠**

| 代码长度 | 默认状态 | 行为 |
|---------|---------|------|
| ≤ 500 字符 | 展开 | 直接显示，方便查看 |
| > 500 字符 | 折叠 | 默认隐藏，按需展开 |

### 2. **信息丰富**

折叠状态下显示：
- 📦 代码图标
- 语言类型（xml/json）
- 字符数统计
- 行数统计
- "点击展开" 提示

### 3. **交互友好**

- ✅ 整个头部可点击
- ✅ 底部提示可点击
- ✅ 悬停高亮效果
- ✅ 箭头动画指示

### 4. **性能优化**

- ✅ 减少初始渲染的 DOM 数量
- ✅ 长代码不会占用聊天空间
- ✅ 按需加载，提高性能

---

## 🔧 代码实现

### **核心逻辑**

```typescript
// 1. 判断代码长度
const codeContent = String(children).replace(/\n$/, "")
const isLongCode = codeContent.length > 500

// 2. 设置默认展开状态
<Collapsible defaultOpen={!isLongCode}>

    {/* 3. 可点击的头部 */}
    <CollapsibleTrigger className="w-full px-3 py-1.5 ...">
        <div className="flex items-center gap-2">
            <Code className="h-3.5 w-3.5 text-blue-400" />
            <span>{language}</span>
            {isLongCode && (
                <span>({codeContent.length} 字符, {remainingLines}+ 行)</span>
            )}
        </div>
        {isLongCode && <ChevronDown className="h-4 w-4" />}
    </CollapsibleTrigger>

    {/* 4. 折叠的内容 */}
    <CollapsibleContent>
        <div className="max-h-[300px] overflow-y-auto">
            <CodeBlock code={codeContent} language={language} />
        </div>
    </CollapsibleContent>

    {/* 5. 底部展开提示（仅长代码折叠时显示） */}
    {isLongCode && (
        <div className="px-3 py-2 ...">
            <CollapsibleTrigger>
                点击展开查看完整代码...
            </CollapsibleTrigger>
        </div>
    )}
</Collapsible>
```

---

## 📊 对比效果

### **之前**（所有代码都展开）

```
┌────────────────────────────────────┐
│ AI 助手                             │
├────────────────────────────────────┤
│ 📦 xml                             │
│ <mxfile>                            │
│   <diagram id="page-1">             │
│     <mxGraphModel dx="1422"...>     │
│       <root>                        │
│         <mxCell id="2"...>          │
│         <mxCell id="3"...>          │
│         ...100+ 行代码...           │
│       </root>                      │
│     </mxGraphModel>                │
│   </diagram>                       │
│ </mxfile>                           │
│                                    │
│ ✅ 图表已生成                        │
├────────────────────────────────────┤
│ AI 助手                             │
├────────────────────────────────────┤
│ 📦 xml                             │
│ <mxfile>                            │
│   ...100+ 行代码...                 │
│ </mxfile>                           │
│                                    │
│ ✅ 图表已生成                        │
└────────────────────────────────────┘

❌ 需要滚动很久才能看到历史消息
❌ 所有代码都占用空间
❌ 难以浏览
```

### **现在**（长代码默认折叠）

```
┌────────────────────────────────────┐
│ AI 助手                             │
├────────────────────────────────────┤
│ 📦 xml (5234 字符, 128+ 行)    ▼  │
│ 点击展开查看完整代码...             │
│ ✅ 图表已生成                        │
├────────────────────────────────────┤
│ AI 助手                             │
├────────────────────────────────────┤
│ 📦 json (256 字符)                 │
│ {                                   │
│   "name": "test"                   │
│ }                                   │
│ ✅ 图表已生成                        │
├────────────────────────────────────┤
│ AI 助手                             │
├────────────────────────────────────┤
│ 📦 xml (4512 字符, 98+ 行)      ▼  │
│ 点击展开查看完整代码...             │
│ ✅ 图表已生成                        │
└────────────────────────────────────┘

✅ 聊天面板简洁清晰
✅ 可以快速浏览历史消息
✅ 按需展开查看详细代码
✅ 更好的用户体验
```

---

## 🎉 总结

### **优化效果**

| 指标 | 优化前 | 优化后 |
|------|--------|--------|
| **聊天面板高度** | 很长，需要大量滚动 | 紧凑，一目了然 |
| **历史消息可见性** | 差，被代码淹没 | 好，清晰可见 |
| **代码可访问性** | 好，但拥挤 | 好，按需展开 |
| **用户体验** | ⭐⭐ | ⭐⭐⭐⭐⭐ |

### **使用的 shadcn/ui 组件**

- ✅ **Collapsible** - 折叠容器
- ✅ **CollapsibleTrigger** - 触发器
- ✅ **CollapsibleContent** - 内容区
- ✅ **ScrollArea** - 滚动区域（已有）
- ✅ **Button** - 按钮（已有）

所有组件都来自 `components/ui`，完全复用你的 shadcn/ui 库！🎨

### **关键特性**

✅ **智能折叠** - 超过500字符自动折叠
✅ **信息提示** - 显示字符数和行数
✅ **交互友好** - 多处可点击区域
✅ **性能优化** - 减少初始渲染
✅ **可滚动** - 展开后可滚动查看完整代码
✅ **美观** - 图标、动画、悬停效果

现在聊天面板清爽多了！🎉
